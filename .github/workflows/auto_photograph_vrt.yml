name: Auto Android Visual Regression Testing

on:
  pull_request:
    types: [opened, reopened]

env:
  GH_TOKEN: ${{ secrets.REPO_GITHUB_TOKENS }}

jobs:
  auto-android-vrt:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.REPO_GITHUB_TOKENS }}
          fetch-depth: 0

      - name: Skip if VRT image update commit
        id: check-commit
        run: |
          # æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
          LATEST_COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Latest commit message: $LATEST_COMMIT_MSG"
          
          # VRTç”»åƒæ›´æ–°ã®ã‚³ãƒŸãƒƒãƒˆã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
          if echo "$LATEST_COMMIT_MSG" | grep -q ":green_heart: VRTç”»åƒæ›´æ–°"; then
            echo "â­ï¸ VRTç”»åƒæ›´æ–°ã®ã‚³ãƒŸãƒƒãƒˆã®ãŸã‚ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… é€šå¸¸ã®ã‚³ãƒŸãƒƒãƒˆã®ãŸã‚ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã—ã¾ã™"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up JDK 21
        if: steps.check-commit.outputs.skip != 'true'
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Gradle
        if: steps.check-commit.outputs.skip != 'true'
        uses: gradle/gradle-build-action@87a9a15658c426a54dd469d4fc7dc1a73ca9d4a6 # v2.10.0
        with:
          gradle-version: wrapper

      - name: workaround for detached HEAD
        if: steps.check-commit.outputs.skip != 'true' && github.event_name == 'pull_request'
        run: |
          BRANCH_NAME=${GITHUB_HEAD_REF#refs/heads/}
          echo "ãƒ–ãƒ©ãƒ³ãƒåˆ‡ã‚Šæ›¿ãˆï¼š $BRANCH_NAME"
          echo "ç¾åœ¨ã®çŠ¶æ…‹ï¼š$(git branch --show-current 2>/dev/null || echo 'detached HEAD')"
          
          if git checkout "$BRANCH_NAME" 2>/dev/null; then
            echo "âœ…ã€€ãƒ–ãƒ©ãƒ³ãƒ $BRANCH_NAME ã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ"
            git pull origin "$BRANCH_NAME" || true
          else 
            echo "ãƒ–ãƒ©ãƒ³ãƒ $BRANCH_NAME ãŒå­˜åœ¨ã—ãªã„ãŸã‚æ–°è¦ä½œæˆã—ã¾ã™"
            git checkout -b "$BRANCH_NAME"
            git pull origin "$BRANCH_NAME" || true
          fi
          
          echo "åˆ‡ã‚Šæ›¿ãˆå¾Œã®çŠ¶æ…‹ï¼šã€€$(git branch --show-current 2>/dev/null || echo 'detached HEAD')"
          echo "vrt_mapping.txtã®å­˜åœ¨ç¢ºèª"
          if [ -f ".github/workflows/vrt_mapping.txt" ]; then
            echo " âœ…ã€€.github/workflows/vrt_mapping.txtã€€ãŒå­˜åœ¨ã—ã¾ã™"
          else
            echo " mapping.txtãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€€"
            echo " .github/workflows/ã®å†…å®¹ï¼š" 
            ls -la .github/workflows/ 2>/dev/null || echo " ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
          fi


      - name: Check changed files and run VRT tests
        if: steps.check-commit.outputs.skip != 'true'
        id: check-and-run-vrt
        run: |
          # PRã®å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ï¼ˆãƒãƒ¼ã‚¸ãƒ™ãƒ¼ã‚¹ã¨ã®å·®åˆ†ã¨ã€ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å¤‰æ›´ã‚‚å«ã‚ã‚‹ï¼‰
          BASE_SHA=$(git merge-base origin/${{ github.base_ref }} HEAD)
          CHANGED_FILES=$( \
            { git diff --name-only $BASE_SHA HEAD; \
              git diff --name-only; \
              git diff --cached --name-only; } | sort -u | grep -E '\.(kt|ktx)$' || true \
          )
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # vrt_mapping.txtã®ã™ã¹ã¦ã®source_fileï¼ˆä¸€ç•ªå·¦ã®ãƒ•ã‚¡ã‚¤ãƒ«åï¼‰ã‚’å–å¾—
          MAPPING_FILE=""
          for path in "$GITHUB_WORKSPACE/.github/workflows/vrt_mapping.txt" ".github/workflows/vrt_mapping.txt" "$(pwd)/.github/workflows/vrt_mapping.txt"; do
            if [ -f "$path" ]; then
              MAPPING_FILE="$path"
              echo "âœ…ã€€vrt_mapping.txtãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼š $MAPPING_FILE"
              break
            fi
          done
          
          # ã¾ã è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã‚‹
          if [ -z "$MAPPING_FILE" ]; then
            echo "ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã§ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚mainãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã¾ã™"
            # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
            mkdir -p .github/workflows
            # mainãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
            if git show origin/main:.github/workflows/vrt_mapping.txt > .github/workflows/vrt_mapping.txt 2>/dev/null; then
              MAPPING_FILE=".github/workflows/vrt_mapping.txt"
              echo "âœ…mainãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰vrt_mapping.txtã‚’å–å¾—ã—ã¾ã—ãŸ"
            else
              echo "mainãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã‚‚å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"
            fi
          fi
          
          if [ -n "$MAPPING_FILE" ] && [ -f "$MAPPING_FILE" ]; then
            # ã™ã¹ã¦ã®è¡Œã®1åˆ—ç›®ï¼ˆsource_fileï¼‰ã‚’å–å¾—ã—ã€é‡è¤‡ã‚’æ’é™¤
            REQUIRED_FILES=$(cut -d'|' -f1 "$MAPPING_FILE" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sort -u)
          
            echo "Required files from vrt_mapping.txt:"
            echo "$REQUIRED_FILES"
          
            # 1ã¤ã§ã‚‚source_fileãŒå¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            FOUND_FILE=""
            while IFS= read -r required_file; do
              if [ -n "$required_file" ]; then
                if echo "$CHANGED_FILES" | grep -qE "(^|/)$required_file$"; then
                  if [ -z "$FOUND_FILE" ]; then
                    FOUND_FILE="$required_file"
                  else
                    FOUND_FILE="$FOUND_FILE $required_file"
                  fi
                fi
              fi
            done <<< "$REQUIRED_FILES"
          
            # 1ã¤ã§ã‚‚å«ã¾ã‚Œã¦ã„ã‚Œã°å®Ÿè¡Œã€1ã¤ã‚‚å«ã¾ã‚Œã¦ã„ãªã‘ã‚Œã°åœæ­¢
            if [ -z "$FOUND_FILE" ]; then
              echo "âš ï¸ PRã®å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã«vrt_mapping.txtã®source_fileãŒ1ã¤ã‚‚å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’åœæ­¢ã—ã¾ã™ã€‚"
              echo "should_stop=true" >> $GITHUB_OUTPUT
              echo "has_tests=false" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "âœ… PRã®å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã«ä»¥ä¸‹ã®source_fileãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚"
              echo "$FOUND_FILE" | tr ' ' '\n'
              echo "should_stop=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ vrt_mapping.txt ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"
            echo "ãƒ‡ãƒãƒƒã‚°æƒ…å ±"
            echo "ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼š$(pwd)"
            echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
            echo "ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒï¼š $(git branch --show-current 2>/dev/null || echo 'detached HEAD')"
            echo ".github/workflows/ ã®å†…å®¹ï¼š"
            ls -la .github/workflows/ 2>/dev/null || echo "   ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
            echo "should_stop=false" >> $GITHUB_OUTPUT
          fi
          
          # vrt_mapping.txtã‚’èª­ã¿è¾¼ã‚“ã§ã€å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒãƒƒãƒã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
          TEST_NAMES=""
          
          if [ -n "$MAPPING_FILE" ] && [ -f "$MAPPING_FILE" ]; then
            while IFS="|" read -r source_file test_name; do
              # source_fileã®å‰å¾Œã®ç©ºç™½ã‚’å‰Šé™¤
              source_file=$(echo "$source_file" | xargs)
              test_name=$(echo "$test_name" | xargs)
          
              # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã«source_fileãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã®ã¿ã§ãƒãƒƒãƒï¼‰
              if echo "$CHANGED_FILES" | grep -qE "(^|/)$source_file$"; then
                if [ -n "$test_name" ] && [ "$test_name" != "" ]; then
                  echo "Found matching file: $source_file -> Test: $test_name"
                  if [ -z "$TEST_NAMES" ]; then
                    TEST_NAMES="$test_name"
                  else
                    # é‡è¤‡ã‚’é¿ã‘ã‚‹
                    if echo "$TEST_NAMES" | grep -qv "$test_name"; then
                      TEST_NAMES="$TEST_NAMES $test_name"
                    fi
                  fi
                fi
              fi
            done < "$MAPPING_FILE"
          fi
          
          if [ -n "$TEST_NAMES" ]; then
            echo "test_names=$TEST_NAMES" >> $GITHUB_OUTPUT
            echo "has_tests=true" >> $GITHUB_OUTPUT
            echo "Tests to run: $TEST_NAMES"
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
            echo "No matching tests found for changed files"
          fi

      - name: Run Android VRT Tests
        id: run-vrt-tests
        if: steps.check-commit.outputs.skip != 'true' && steps.check-and-run-vrt.outputs.should_stop != 'true' && steps.check-and-run-vrt.outputs.has_tests == 'true'
        run: |
          # å¿…è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰å–å¾—
          mkdir -p .github/workflows
          
          if [ ! -f ".github/workflows/auto_photograph_vrt.sh" ]; then
            echo "auto_photograph_vrt.shãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã¾ã™"
            if git show origin/main:.github/workflows/auto_photograph_vrt.sh > .github/workflows/auto_photograph_vrt.sh 2>/dev/null/; then
              echo "âœ…ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰auto_photograph_vrt.shã‚’å–å¾—ã—ã¾ã—ãŸ"
            else
              echo "mainãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã‚‚å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"
              exit 1
            fi
          fi
          
          chmod +x .github/workflows/auto_photograph_vrt.sh
          
          TEST_NAMES="${{ steps.check-and-run-vrt.outputs.test_names }}"
          
          # å„ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
          for test_name in $TEST_NAMES; do
            echo "Running VRT test: $test_name"
            .github/workflows/auto_photograph_vrt.sh "$test_name" || true
          done
        continue-on-error: true

      - name: Count VRT Images
        id: count-images
        if: always() && steps.check-commit.outputs.skip != 'true' && steps.check-and-run-vrt.outputs.should_stop != 'true'
        run: |
          SCREENSHOTS_DIR="app/__screenshots__"
          EXPECTED_DIR="app/.reg/expected"
          
          if [ -d "$SCREENSHOTS_DIR" ]; then
            TOTAL=$(find "$SCREENSHOTS_DIR" -name "*.png" | wc -l)
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
          else
            echo "total=0" >> $GITHUB_OUTPUT
          fi
          
          if [ -d "$EXPECTED_DIR" ]; then
            EXPECTED=$(find "$EXPECTED_DIR" -name "*.png" | wc -l)
            echo "expected=$EXPECTED" >> $GITHUB_OUTPUT
          else
            echo "expected=0" >> $GITHUB_OUTPUT
          fi

      - name: Check for PNG changes and commit
        if: steps.check-commit.outputs.skip != 'true' && steps.check-and-run-vrt.outputs.should_stop != 'true' && steps.check-and-run-vrt.outputs.has_tests == 'true'
        run: |
          # Gitè¨­å®š
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          
          # expectedãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®PNGãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’ç¢ºèª
          if [ -d "app/.reg/expected" ]; then
            # å¤‰æ›´ã•ã‚ŒãŸPNGãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡º
            PNG_CHANGES=$(git status --porcelain app/.reg/expected/ 2>/dev/null | grep -E '\.png$' || true)
          
            if [ -n "$PNG_CHANGES" ]; then
              echo "PNG changes detected:"
              echo "$PNG_CHANGES"
          
              # PNGãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
              git add app/.reg/expected/*.png
          
              # å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆ
              if ! git diff --staged --quiet; then
                git commit -m ":green_heart: VRTç”»åƒæ›´æ–° [skip ci]"
                git push origin ${{ github.head_ref }}
                echo "âœ… PNGãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
                echo "pushed=true" >> $GITHUB_OUTPUT
              else
                echo "âš ï¸ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸå¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“"
                echo "pushed=false" >> $GITHUB_OUTPUT
              fi
            else
            echo "â„¹ï¸ PNGãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
            echo "pushed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "â„¹ï¸ app/.reg/expected ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
            echo "pushed=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment VRT Summary on PR
        if: always() && steps.check-commit.outputs.skip != 'true' && steps.check-and-run-vrt.outputs.should_stop != 'true'
        env:
          VRT_TEST_CONCLUSION: ${{ steps.run-vrt-tests.conclusion }}
          TOTAL_IMAGES: ${{ steps.count-images.outputs.total }}
          EXPECTED_IMAGES: ${{ steps.count-images.outputs.expected }}
          GH_TOKEN: ${{ env.GH_TOKEN }}
        run: |
          PR_NUMBER=$(jq --raw-output .pull_request.number "$GITHUB_EVENT_PATH")
          
          COMMENT_BODY="### Android VRTãƒ¬ãƒãƒ¼ãƒˆ\n\n"
          
          # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          if [ "$VRT_TEST_CONCLUSION" = "failure" ]; then
            STATUS="ğŸ”´VRTãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸï¼"
            COMMENT_BODY+="VRTãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\n"
          elif [ "$VRT_TEST_CONCLUSION" = "skipped" ]; then
            STATUS="âš ï¸VRTãƒ†ã‚¹ãƒˆãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸï¼"
          elif [ "$VRT_TEST_CONCLUSION" = "cancelled" ]; then
            STATUS="âš ï¸VRTãƒ†ã‚¹ãƒˆãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸï¼"
          else
            STATUS="ğŸŸ¢VRTãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼"
            COMMENT_BODY+="ç”Ÿæˆç”»åƒæ•°: $TOTAL_IMAGES, æ­£è§£ç”»åƒæ•°: $EXPECTED_IMAGES \n\n"
          fi
          
          COMMENT_BODY+="$STATUS"
          
          # ã‚³ãƒ¡ãƒ³ãƒˆã‚’PRã«æŠ•ç¨¿
          echo -e "$COMMENT_BODY" | gh pr comment $PR_NUMBER --body-file -

      - name: Upload VRT Screenshots as Artifact
        if: failure() && steps.check-commit.outputs.skip != 'true' && steps.check-and-run-vrt.outputs.should_stop != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: Android-VRT-Screenshots
          path: |
            app/__screenshots__/**
            app/.reg/expected/**
          retention-days: 3
          if-no-files-found: ignore

      - name: Comment VRT Failure Details on PR
        if: failure() && steps.check-commit.outputs.skip != 'true' && steps.check-and-run-vrt.outputs.should_stop != 'true'
        run: |
          PR_NUMBER=$(jq --raw-output .pull_request.number "$GITHUB_EVENT_PATH")
          ARTIFACT_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts"
          
          COMMENT_BODY="### VRTãƒ†ã‚¹ãƒˆå¤±æ•—è©³ç´° \n\n"
          COMMENT_BODY+="**[ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰]($ARTIFACT_URL)**\n\n"
          COMMENT_BODY+="ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ã€å¤±æ•—åŸå› ã‚’ç‰¹å®šã—ã¦ãã ã•ã„ã€‚\n"
          
          # ã‚³ãƒ¡ãƒ³ãƒˆã‚’PRã«æŠ•ç¨¿
          echo -e "$COMMENT_BODY" | gh pr comment $PR_NUMBER --body-file -
        env:
          GH_TOKEN: ${{ env.GH_TOKEN }}

